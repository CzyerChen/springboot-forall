> 什么是幂等？什么时候需要处理幂等？

### 幂等的概念
- 我们在组件间调用的时候经常会因为请求量、网络延时、机器故障等原因，出现调用超时甚至调用失败
- 情况一：请求接口方会多次发出同一个请求（网页端重复发起），被调用方就会接收到多次相同的请求（如果是查询，那可能只是对数据库的压力变大一些，但是是一些增删改的情况，订单的新增，金额的修改，都可能会导致异常）
- 情况二：一旦上层调用方异步调用没有响应，可能会引发多次回调，需要做好控制

### 常见的解决方案
- 方案一：对于新增写入的场景（ID自己设定，不用自增或随机的方式，比如利用用户的信息生成的ID），利用数据库的唯一值索引来过滤重复请求
- 方案二：token的过期机制（不能使用超时过期，而是每次提交都会返还一个新的token），能够有效防止同一个请求连续提交多次的可能，但是token的频繁刷新也需要考虑性能
- 方案三：悲观锁，在获取数据的时候加锁
- 方案四：乐观锁，通过数据库版本号字段，在数据写入时做校验
- 方案五：分布式锁，利用redis/zookeeper对相应数据加锁
- 方案六：状态机，对数据进行状态的追踪，对非法和重复的状态进行过滤

### 常见方法详解
##### 在云平台的常规操作中，一般会使用token+redis的方式来校验
- 每次请求都需要带上身份验证的token，token存储在redis缓存中
- 基本的思想就是每次请求都带了上一次请求的token，然后进入请求进行token的匹配
- 存在则通过身份认证，并删除Redis中的token，进行业务，业务结束，生成新的token，放入缓存，并返回给前端，
- 不存在就是token已被使用或者就是没有进行身份认证了，已被使用可能就是重复操作导致的
- 流程：
```text
       1. 配置Redis连接
       
       2. 缓存服务，用于校验token是否携带，token是否有效
       首先检测是否携带token进行校验：不存在肯定是非法的
       其次看是否有效，以删除换返回值的方式，如果删除成功，则证明token有效，并删除成功，如果不成功，证明token无效，不存在对应缓存
        Long del = jedisUtil.del(token); //删除换结果
        if(del<=0){//考察返回值情况，不然存在并发安全性问题，不校验结果，无法知道token是否是有效的
            throw new Exception("token非法");
        }

       3. 书写注解，用于标志是否需要检测token
       
       4. 添加拦截器，在请求接口之前，检测token是否合法，不合法抛出异常
       
       5. 注入拦截器
       
       6. 启动测试
```
