> [张开涛：会话的分布式及权限的集中管理](https://github.com/zhangkaitao/shiro-example/),实现统一域名下的会话权限管理

> 跨域实现需要使用CAS或者OAuth2实现


> spring mvc 
> mysql/ redis,结合redis的过期机制，可以做会话的过期
> shiro 


呈现了分布式会话管理的比较经典的基础实现

```text
 部署架构图


                                |------> 用户权限 server
                                |
                                |
 客户端   ----->   Nginx     ----|----->  应用程序1
               请求代理服务器    |
                                |
                                |------>  应用程序2
```
nginx负责请求的过滤和转发，用户权限服务器主要处理login的任务，比如一个单点登陆的服务器，应用程序1 和 应用程序2 处理不同的业务，但是都依赖于用户的登录认证


- nginx的配置
```text
server {
listen 80;
server_name localhost;
charset utf-8;

location ~ ^/(server)/ {  //以server开头的请求
proxy_pass http://127.0.0.1:8080;
index /;
proxy_set_header Host $host;
}
location ~ ^/(app1)/ {    //以app1开头的请求
proxy_pass http://127.0.0.1:8081;
index /;
proxy_set_header Host $host;
}
location ~ ^/(app2)/ {     //以app2开头的请求
proxy_pass http://127.0.0.1:8082;
index /;
proxy_set_header Host $host;
}
}
```

```text
项目架构图

      |---------> 权限存储（Mysql + redis）
      |                       /|\
      |                        |
      |                        |
      |                        |           |-----应用程序1
用户权限server <-------- 客户端 client <----|
                                           |-----应用程序2

```
```text
模块依赖图

                     POM  --- 版本控制，依赖管理的父类
                     /|\
                      |
                      |
                      |
                    Core  --- 核心类，提供一些顶层封装和实现
                     /|\
                      |
                      |
       |-------------------------------|
       |                               |
     server                          client 应用模块获取会话及应用对应的权限信息
    身份认证服务器                      |
    保证单点登录                        |
                             |--------------------|
                         应用程序1            应用程序2

```



```text
总结：
1、没有加缓存；

2、客户端每次获取会话/权限都需要通过客户端访问服务端；造成服务端单点和请求压力
大；单点可以考虑使用集群来解决；请求压力大需要考虑配合缓存服务器（如Redis）来解
决；即每次会话/权限获取时首先查询缓存中是否存在，如果有直接获取即可；否则再查服
务端；降低请求压力；

3、会话的每次更新（比如设置属性/更新最后访问时间戳）都需要同步到服务端；也造成
了请求压力过大；可以考虑在请求的最后只同步一次会话（需要对Shiro 会话进行改造，
通过如拦截器在执行完请求后完成同步，这样每次请求只同步一次）；

4、只能同域名才能使用，即会话ID 是从同一个域名下获取，如果跨域请考虑使用
CAS/OAuth2 之实现。

```


